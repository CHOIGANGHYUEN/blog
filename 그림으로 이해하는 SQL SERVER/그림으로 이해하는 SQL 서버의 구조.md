## 4장 데이터베이스 구조의 원리

### 4.1 데이터 파일

#### 4.1.1 페이지와 익스텐트

![Alt text](image.png)
데이터 베이스를 구성하는 데이터 파일은 내부적으로 **페이지**라고 하는 8kb의 논리단위로 구분되어 사용된다.

페이지는 테이블 등의 오브젝트에 저장된 데이터으 참조와 변경 시 최소 논리 I/O 단위로 사용된다.

- 페이지
  - 8kb의 논리단위
  - 최소 논리 I/O단위로 사용(데이터 참조 / 변경)

오브젝트에 새로운 영역을 할당해야 하는 경우에는 페이지가 아닌 **익스텐트**라는 단위가 사용된다.

익스텐트는 8kb의 페이지가 8개로 구성된 단위이다.

테이블에 할당된 모든 페이지에 빈 용량이 없어지면 테이블에는 새로운 익스텐트가 할당된다.

- 익스텐트
  - 8개의 페이지로 구성
  - 오브젝트에 새로운 영역을 할당할 때

#### 4.1.2 단일 익스텐트와 혼합 익스텐트

익스텐트에는 하나의 오브젝트에 8페이지 모두를 점유하는 **단일 익스텐트**와 복수의 오브젝트에서 공유하는 **혼합 익스텐트** 2종류가 있다.

![Alt text](image-1.png)

- 혼합 익스텐트
  - 혼합 익스텐트 유무 검색
  - 빈 페이지 유무 확인 후 할당
  - 작업량이 많아 할당이 빈번하면 처리 시간이 지연되는 경우가 있다.
- 단일 익스텐트
  - 모든 페이지가 하나의 오브젝트에 링크
  - 단순히 그 안의 페이지를 할당하면 됨.
  - 오브젝트의 사이즈가 1페이지보다 커지지 않는다면 7페이지가 낭비 됨.

SQL 서버 2014까지는 혼합 익스텐트가 디폴트였으나 SQL 서버 2016 부터는 단일 익스텐트가 디폴트가 되었다.

```SQL
-- ALTER DATABASE 스테이트먼트에서, MIXED_PAGE_ALLOCATION 옵션으로 디폴트 동작을 변경 할 수 있다.

-- 혼합 익스텐트 할당을 무효화(디폴트 설정)
ALTER DATABASE AdventureWorks2012
SET ALLOW_SNAPSHOT_ISOLATION OFF;
GO;

-- 혼합 익스텐트 할당을 유효화
ALTER DATABASE AdventureWorks2012
SET ALLOW_SNAPSHOT_ISOLATION ON;
GO;
```

#### 4.1.3 페이지의 종류

데이터 파일 내의 페이지는 다음 중 어느 쪽인가를 저장하는 용도로 사용된다.( 관리 정보 저장용 페이지는 제외)

- IN_ROW_DATA : 데이터 또는 인덱스를 저장
- LOB_DATA : 라지 오브젝트(text, ntext, image, xml, varchar(max), nvarchar(max), varbinary(max))를 저장
- ROW_OVERFLOW_DATA : 페이지 상한인 8KB를 넘는 가변 길이 칼럼의 데이터를 저장

#### 4.1.4 페이지의 배치

데이터 파일의 대부분의 페이지는 데이터와 인덱스 키를 저장하는데 사용 되지만, 극히 소수의 관리 정보만을 저장한 페이지가 있다.

관리 정보만 저장한 페이지는 데이터베이스를 효율적으로 관리하기 위해 데이터베이싀 할당 정보를 보관하고 있다.

- 관리 정보 페이지
  - 관리 정보만 저장
  - 데이터베이스 효율적인 관리

**GAM**</br>
8kb의 페이지 내 각 비트가 익스텐트의 상황을 나타낸다. 만약 비트의 값이 1을 나타내는 경우는 대응하는 데이터베이스 내의 익스텐트가 할당되어 있지 않았음을 나타낸다. 단일 익스텐트에 할당되면 비트의 값은 0으로 설정된다.

1개의 GAM 페이지에서 64000익스텐트분(4GB)의 상태를 관리할 수 있다. SQL 서버가 오브젝트에 익스텐트를 새로 할당하는 경우에는 이 페이지를 참조해서 효율적으로 미사용 페이지의 익스텐트를 찾아낼 수 있다.

- 익스텐트가 할당 됨 : 0
- 익스텐트가 할당 됨X : 1

![Alt text](image-2.png)

**SGAM**</br>
이것은 혼합 익스텐트의 상황을 나타내느 페이지.
GAM과 마찬가지로 8KB분의 각 비트가 대응하는 익스텐트의 상황을 나타낸다. 1이 설정되어 있는 경우는 혼합 익스텐트로 할당되어 빈 페이지가 존재하는 것을 나타낸다.

0인 경우엔 빈 페이지가 존재하지 않지만, 혼합 익스텐트로 할당되어 있지 않음을 나타낸다.

![Alt text](image-3.png)

**PFS(Page Free Space**</br>
8kb페이지에 각 바이트가 대응하는 페이지의 상황을 나타내고 8000 페이지 분의 정보를 저장한다.

페이지 사용, 미사용 같은 정보를 추가하면 페이지 사용률도 확인이 가능하다.

PFS의 정보를 사용해 새로운 데이터를 저장하기 위한 페이지를 찾는다.

다만 인덱스 페이지는 인덱스 키 값에 따라 저장해야할 장소가 정해진다.

따라서 PFS는 힙이나 Text/Iamge 데이터의 저장 장소 검색을 위해서만 사용된다.

![Alt text](image-4.png)
